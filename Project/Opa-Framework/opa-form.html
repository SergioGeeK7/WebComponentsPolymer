<link rel="import" href="../www/lib/polymer/polymer.html">
<link rel="import" href="../www/lib/paper-button/paper-button.html">
<link rel="import" href="../www/lib/iron-form/iron-form.html">
<link rel="import" href="../www/lib/iron-ajax/iron-ajax.html">
<link rel="import" href="opa-form-components/opa-input.html">
<link rel="import" href="opa-form-components/opa-checkbox.html">
<link rel="import" href="opa-form-components/opa-select.html">
<script src="../structure.js"></script>
<script src="../editModeExample.js"></script>


<dom-module id="opa-form">

    <template>
        <style>
            paper-button {
                background-color: #4285f4;
                color: #fff;
                margin-top: 50px;
                width: 100%;
                text-transform: capitalize;
            }
            
            opa-checkbox {
                display: block;
                margin-top: 15px;
                margin-bottom:15px;
            }

        </style>

        <form is="iron-form" id="form" method="post" action="/checkout" iron-form-submit="_handleFormSubmit">

            <template is="dom-repeat" items="{{data}}" as="element" index-as="indexElement">

                 <template is="dom-if" if="[[element.isInput]]">
                    <opa-input name="[[element.name]]" required="[[element.require]]" placeholder="{{element.label}}" label="[[element.label]]" type="[[element.type]]" max="[[element.max]]" min="[[element.min]]" pattern="[[element.pattern]]" errormessage="[[element.errorMessage]]" len="[[element.len]]" id="[[element.name]]"></opa-input>
                </template>
                
                <template is="dom-if" if="[[element.isCheckbox]]">
                    <opa-checkbox name="[[element.name]]" label="[[element.label]]" required="[[element.require]]" id="[[element.name]]"></opa-checkbox>
                </template>

                <template is="dom-if" if="[[element.isSelect]]">
                    <opa-select fill="[[element.fill]]" name="[[element.name]]" label="[[element.label]]" required="[[element.require]]" selected="{{element.identity.value}}" paramss="[[_onSelectChange(element.*)]]" whorequire="[[element.whoRequire]]" id="[[element.name]]">
                    </opa-select>
                </template>
               
            </template>


            <!-- VALIDAR CON EL NAME PARA MOSTRAR EL MENSAJE DE ERROR -->
            <!-- HACER OTRO IF PARA EL TIPO NUMBER Y ESPEFICIFAR EL MAX Y MIN -->
            <!-- 
            <opa-input name="name" required="false"></opa-input>
            <opa-input name="age" type="number" required="true"></opa-input>
            <opa-checkbox name="notify" label="Notificacones"></opa-checkbox>
            -->

            <paper-button on-click="_submit">Enviar</paper-button>
        </form>


    </template>

</dom-module>


<!-- this.push('employees', { first: 'Jack', last: 'Aubrey' }); -->
<!-- model.set('item.ordered', model.item.ordered+1); -->
<!--
fill: ""
label: "Nombre"
len: 15
lostFocus: ""
name: "name"
require: 1
type: "string"
-->

<!-- 

data.filter(function (item){ return item.whoRequire && item.whoRequire.length })

-->

<script>
    Polymer({
        is: 'opa-form',
        listeners: {
            "form.iron-form-presubmit": '_handleFormSubmit'
        },
        ready: function() {
        
            // change to created event .... for performance
            this.data = data.map(function(item) {

                item.isInput = item.type === "text" || item.type === "number";
                item.isSelect = item.type === "select";
                item.isCheckbox = item.type === "bit";
                item.identity = {
                    name:item.name,
                    value: void(0)
                };
                return item;
            });
            
            this.data.forEach(function (item,index,I){    
                    if(typeof item.whoRequire === "undefined" || !item.whoRequire.length) 
                        return;
                    
                    var requiredElements = I.filter(function (itemFilter){
                        return item.whoRequire.indexOf(itemFilter.name) > -1;
                    });
                    
                    item.whoRequire = requiredElements.map(function (required){
                        return required.identity; 
                    });
                
            });
             
            
        },
        attached:function (){
            this._fillForm(dataEdit);
        },
        _onSelectChange:function (hasChanged){
            
                  
            var elementChanged = hasChanged.base.name;
            var selects = [].slice.call(document.querySelectorAll("opa-select"));
            
            var selectRequired = selects.forEach(function (select){
                
                if (!select.whorequire || !select.whorequire.filter(filterByProperty.bind(hasChanged.base)).length)
                    return;
                
                var property = select.whorequire.reduce(function (obj,item){
                    obj[item.name] = item.value;
                    return obj;
                 },{});
               
                select.selectedId = null;
                select.params = property;
            });
            
            function filterByProperty (item){
                return item.name === this.name;
            }
            
        },
        ageHasChanged:function (item){
            console.log(item);
        },
        observers: [
           // "ageHasChanged(data.*)",
        ],
        _submit: function() {
            if (!this.$.form.validate())
                return alert("ta malo");
            this.$.form.submit();
        },
        _handleFormSubmit: function(e) {

            e.preventDefault();
            console.log(this.$.form.serialize());
        },  
        _fillForm:function (data){
            
            for (var i in data){
                if(i === "id")continue;
                document.querySelector('#' + i).value =   data[i];
                document.querySelector('#' + i).selectedId =   data[i];
            }
        }

    });

</script>
