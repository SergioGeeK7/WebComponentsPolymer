<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="opa-input.html">
<link rel="import" href="opa-checkbox.html">
<link rel="import" href="opa-select.html">
<link rel="import" href="opa-button.html">

<dom-module id="opa-form">

    <template>
        <style>
            paper-button {
                color: #fff;
                margin: 10px;
                width: 100%;
                text-transform: capitalize;
            }
            
            paper-button.save {
                background-color: #4285f4;
            }
            
            paper-button.wipe {
                background-color: rgba(17, 206, 46, 0.83);
            }
            
            paper-button.delete {
                background-color: rgba(36, 42, 37, 0.68);
            }
            
            opa-checkbox {
                display: block;
                margin-top: 15px;
                margin-bottom: 15px;
            }
            
            .botonera {
                width: 100%;
            }
            
            paper-button[disabled],
            paper-button[toggles][active] {
                opacity: 0.6;
            }

        </style>

        <iron-ajax auto url="[[structure]]" handle-as="json" params='{{params}}' on-response='handleResponse'>
        </iron-ajax>

        <form is="iron-form" id="form" action="[[action]]" method="[[method]]">

            <template is="dom-repeat" items="{{data}}" as="element" index-as="indexElement" id="inputrepeat">

                <template is="dom-if" if="[[element.isInput]]">
                    <opa-input name="[[element.name]]" required="[[element.require]]" placeholder="{{element.label}}" label="[[element.label]]" type="[[element.type]]" max="[[element.max]]" min="[[element.min]]" pattern="[[element.pattern]]" errormessage="[[element.errorMessage]]" len="[[element.len]]" id="[[element.name]]" class="opa-element"></opa-input>
                </template>

                <template is="dom-if" if="[[element.isCheckbox]]">
                    <opa-checkbox name="[[element.name]]" label="[[element.label]]" required="[[element.require]]" id="[[element.name]]" class="opa-element"></opa-checkbox>
                </template>

                <template is="dom-if" if="[[element.isSelect]]">
                    <opa-select fill="[[element.fill]]" name="[[element.name]]" label="[[element.label]]" required="[[element.require]]" selected="{{element.identity.value}}" paramss="[[_onSelectChange(element.*)]]" whorequire="[[element.whoRequire]]" id="[[element.name]]" class="opa-element" on-click="__onSelectClick">
                    </opa-select>
                </template>

                <template is="dom-if" dom-change="onchange" on-dom-change="__lastElementDomChange" title="[[indexElement]]">
                    <h1>Dom has changed</h1>
                </template>

            </template>

            <div>

                <div class="botonera">

                    <paper-button class="save" on-click="_save">
                        Guardar
                    </paper-button>

                    <paper-button class="wipe" on-click="wipe">
                        <span hidden$="{{botonera.states.create}}">Cancelar</span>
                        <span hidden$="{{!botonera.states.create}}">Limpiar</span>
                    </paper-button>

                    <paper-button class="delete" disabled$="{{!botonera.states.edit}}" on-click="_delete">
                        Eliminar
                    </paper-button>

                </div>

            </div>
        </form>

    </template>

</dom-module>

<!-- this.push('employees', { first: 'Jack', last: 'Aubrey' }); -->
<!-- model.set('item.ordered', model.item.ordered+1); -->
<!--this.fire('dom-change'); 
this._tryRenderChunk();
polymer.html

_render
-->
<script>
    Polymer({
        is: 'opa-form',
        listeners: {
            "form.iron-form-presubmit": '_handleFormSubmit'
        },
        properties: {
            method: String,
            action: String,
            structure: String
        },
        ready: function() {

        },
        __lastElementDomChange: function(e) {

            var lastElement = e.model.indexElement === this.data.length - 1;
            if (lastElement) {
                this.setElementsById();
            }
        },
        handleResponse: function(e) {

            var data = e.detail.response;

            this.data = data.map(function(item) {

                item.isInput = ["text", "number", "password", "date"].indexOf(item.type) > -1;
                item.isSelect = item.type === "select";
                item.isCheckbox = item.type === "bit";

                item.identity = {
                    name: item.name,
                    value: void(0)
                };
                return item;
            });

            this.data.forEach(function(item, index, I) {
                if (typeof item.whoRequire === "undefined" || !item.whoRequire.length)
                    return;

                var requiredElements = I.filter(function(itemFilter) {
                    return item.whoRequire.indexOf(itemFilter.name) > -1;
                });

                item.whoRequire = requiredElements.map(function(required) {
                    return required.identity;
                });
            });

            var self = this;

            this.botonera = {
                states: {
                    edit: false,
                    create: true
                },
                wipe: function() {
                    self.wipe();
                },
                setEditMode: function(id) {
                    self.set("botonera.states.edit", true);
                    self.set("botonera.states.create", false);
                    this.id = id;
                },
                setCreateMode: function() {
                    self.set("botonera.states.create", true);
                    self.set("botonera.states.edit", false);
                    this.id = null;
                    //self.set("botonera.id",null);
                }
            };

            //setTimeout(this.setElementsById.bind(this), 1000);
        },
        attached: function() {

        },
        setElementsById: function() {

            var elements = this.querySelectorAll(".opa-element");
            this.campos = [].reduce.call(elements, function(obj, element) {
                obj[element.id] = element.self;
                return obj;
            }, {});

            this.fire("onFormLoad");
        },
        wipe: function() {

            for (var i in this.campos) {

                this.campos[i].value = null;
                this.campos[i].checked = null;
                this.campos[i].setValue && this.campos[i].setValue(null);
                this.campos[i].invalid = false;
            }
            this.botonera.setCreateMode();
        },
        _onSelectChange: function(hasChanged) {

            var elementChanged = hasChanged.base.name;
            var selects = [].slice.call(this.querySelectorAll("opa-select"));
            var self = this;

            selects.forEach(function(select) {


                var noRequired = !select.whorequire || !select.whorequire.some((item) => item.name === elementChanged);

                if (noRequired)
                    return;

                var queryString = select.whorequire.reduce(function(obj, item) {
                    obj[item.name] = item.value;
                    return obj;
                }, {});

                if (!self.botonera.isFillProcess)
                    select.selectedId = null;

                select.params = queryString;
            });

        },
        __onSelectClick: function() {
            this.botonera.isFillProcess = false;
        },
        ageHasChanged: function(item) {
            console.log(item);
        },
        observers: [
            // "ageHasChanged(data.*)",
        ],
        _submit: function() {
            if (!this.$.form.validate())
                return;
            this.$.form.submit();
        },
        _save: function() {
            this.method = this.botonera.states.edit ? 'put' : 'post';
            this._submit();
        },
        _delete: function() {

            this.$.form.request.method = "delete";
            this.$.form.request.url = this.action;
            this.$.form.request.params = {
                id: this.botonera.id
            };
            this.$.form.request.generateRequest();
            this.wipe();
        },
        _handleFormSubmit: function(e) {

            //e.preventDefault();
            //console.log(this.$.form.serialize());
            this.botonera.setCreateMode();
            this.wipe();
        },
        fill: function(dataFill) {

            if (!dataFill)
                return;
            
            this.botonera.isFillProcess = true;
            this.botonera.setEditMode(dataFill.id);

            for (var i in this.campos){
                
                this.campos[i].value = dataFill[i];
                this.campos[i].selected = dataFill[i];
                this.campos[i].checked = dataFill[i];
                this.campos[i].setValue && this.campos[i].setValue(dataFill[i]);
            }

        }
    });

</script>
