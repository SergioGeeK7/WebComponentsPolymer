<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">


<dom-module id="opa-select">
    <template>
        <style></style>
        <!-- on-response="_fillSelect" -->
        <iron-ajax url="[[fill]]" handle-as="json" last-response="{{data}}" params='{{ajaxParams}}' id="ajax"></iron-ajax>
        <paper-dropdown-menu label="[[label]]" name="[[name]]" value="{{selected}}" selected="{{selectedId}}" id="main">
            <paper-listbox class="dropdown-content" selected="{{selectedId}}" attr-for-selected="value" id="option">
                <template is="dom-repeat" items="{{data}}" as="select">
                    <paper-item value="{{select.key}}">{{select.value}}</paper-item>
                </template>
            </paper-listbox>
        </paper-dropdown-menu>
    </template>
</dom-module>


<script>
    //data.detail.response
    Polymer({
        is: 'opa-select',
        properties: {
            name: String,
            fill: String,
            required: {
                type: String,
                value: "false"
            },
            placeholder: String,
            label: String,
            selected: {
                type: String,
                notify: true,
            },
            whorequire: [],
            params: {
                type: Object,
                notify: true,
                observer: "__paramsHasChanged"
            }
        },
        __paramsHasChanged: function(newValue, oldValue) {
            var isEmpty = Object
                .keys(newValue)
                .some(s => !newValue[s]);
            if (isEmpty)
                return;
            this.ajaxParams = newValue;
            this.$.ajax.generateRequest();
        },
        ready: function() {
            if (this.required === "true") {
                this.$.main.setAttribute("required", true);
            }

            if (!this.whorequire || !this.whorequire.length) {
                this.$.ajax.generateRequest()
            }

            var option = this.$.option;
            this.self = this.$.main;
            this.self.setValue = function(val) {
                option.selected = val;
            };
        }

    });

</script>
